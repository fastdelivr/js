(function(document){const getHours=value=>Math.trunc(value/60/60%60,10);const getMinutes=value=>Math.trunc(value/60%60,10);const getSeconds=value=>Math.trunc(value%60,10);function isNumber(obj){var type=typeof obj;return(type==="number"||type==="string")&&!isNaN(obj-parseFloat(obj))}function formatTime(time=0,displayHours=false,inverted=false){if(!isNumber(time)){return formatTime(null,displayHours,inverted)}const format=value=>`0${value}`.slice(-2);let hours=getHours(time);const mins=getMinutes(time);const secs=getSeconds(time);if(displayHours||hours>0){hours=`${hours}:`}else{hours=""}return`${inverted&&time>0?"-":""}${hours}${format(mins)}:${format(secs)}`}class Thumbnails{constructor(player){this.player=player;this.loaded=false;this.lastMouseMoveTime=Date.now();this.mouseDown=false;this.loadedImages=[];this.elements={thumb:{},scrubbing:{}};this.load()}get enabled(){return this.player.isHTML5&&this.player.isVideo&&this.player.config.thumbnail?.enabled}get config(){return this.player.config.thumbnail}load(){if(this.player.elements.display.seekTooltip){this.player.elements.display.seekTooltip.hidden=this.enabled}if(!this.enabled){return}this.render();this.determineContainerAutoSizing();this.loaded=true;this.listeners()}startMove(event){if(!this.loaded){return}if(!event instanceof Event||!["touchmove","mousemove"].includes(event.type)){return}if(!this.player.media.duration){return}if(event.type==="touchmove"){this.seekTime=this.player.media.duration*(this.player.elements.inputs.seek.value/100)}else{const clientRect=this.player.elements.progress.getBoundingClientRect();const percentage=100/clientRect.width*(event.pageX-clientRect.left);this.seekTime=this.player.media.duration*(percentage/100);if(this.seekTime<0){this.seekTime=0}if(this.seekTime>this.player.media.duration-1){this.seekTime=this.player.media.duration-1}this.mousePosX=event.pageX;this.elements.thumb.time.innerText=formatTime(this.seekTime)}this.showImageAtCurrentTime()}endMove(){this.toggleThumbContainer(false,true)}startScrubbing(event){if(event.button===false||event.button===0){this.mouseDown=true;if(this.player.media.duration){this.toggleScrubbingContainer(true);this.toggleThumbContainer(false,true);this.showImageAtCurrentTime()}}}endScrubbing(){this.mouseDown=false;if(Math.ceil(this.lastTime)===Math.ceil(this.player.media.currentTime)){this.toggleScrubbingContainer(false)}else{this.player.media.addEventListener("timeupdate",()=>{if(!this.mouseDown){this.toggleScrubbingContainer(false)}},{once:true})}}listeners(){const{player}=this;player.on("play",()=>{this.toggleThumbContainer(false,true)});player.on("seeked",()=>{this.toggleThumbContainer(false)});player.on("timeupdate",()=>{this.lastTime=this.player.media.currentTime});let elements=this.player.elements;["mousemove","touchmove","mouseleave","click","mousedown","touchstart","mouseup","touchend"].forEach(item=>{elements.progress.addEventListener(item,event=>{const{thumbnails}=player;if(thumbnails&&thumbnails.loaded){switch(item){case"mousemove":case"touchmove":thumbnails.startMove(event);break;case"mouseleave":case"click":thumbnails.endMove(false,true);break;case"mousedown":case"touchstart":thumbnails.startMove(event);break;case"mouseup":case"touchend":thumbnails.endScrubbing(event);break}}})})}render(){this.elements.thumb.container=document.createElement("div");this.elements.thumb.container.classList.add(this.player.config.classNames.previewThumbnails.thumbContainer);this.elements.thumb.imageContainer=document.createElement("div");this.elements.thumb.imageContainer.className=this.player.config.classNames.previewThumbnails.imageContainer;this.elements.thumb.container.appendChild(this.elements.thumb.imageContainer);const timeContainer=document.createElement("div");timeContainer.className=this.player.config.classNames.previewThumbnails.timeContainer;this.elements.thumb.time=document.createElement("span");this.elements.thumb.time.textContent="00:00";timeContainer.appendChild(this.elements.thumb.time);this.elements.thumb.container.appendChild(timeContainer);if(this.player.elements.progress instanceof Element){this.player.elements.progress.appendChild(this.elements.thumb.container)}this.elements.scrubbing.container=document.createElement("div");this.elements.scrubbing.container.className=this.player.config.classNames.previewThumbnails.scrubbingContainer;this.player.elements.wrapper.appendChild(this.elements.scrubbing.container)}showImageAtCurrentTime(){if(this.mouseDown){this.setScrubbingContainerSize()}else{this.setThumbContainerSizeAndPos()}let config=this.config;let interval=this.player.duration/config.pic_num;const thumbNum=Math.floor(this.seekTime/interval);let qualityIndex=Math.ceil((thumbNum+1)/(config.col*config.row))-1;const hasThumb=thumbNum>=0;if(!this.mouseDown){this.toggleThumbContainer(hasThumb)}if(!hasThumb){return}if(thumbNum!==this.showingThumb){this.showingThumb=thumbNum;this.loadImage(qualityIndex)}}loadImage(qualityIndex=0){const thumbNum=this.showingThumb;const thumbUrl=this.config.urls[qualityIndex];if(!this.currentImageElement||this.currentImageElement.src!==thumbUrl){if(this.loadingImage){this.loadingImage.onload=null}const previewImage=new Image;previewImage.src=thumbUrl;previewImage.dataset.index=thumbNum;this.player.debug.log(`Loading image: ${thumbUrl}`);previewImage.onload=()=>this.showImage(previewImage,qualityIndex,thumbNum,thumbUrl,true);this.loadingImage=previewImage;this.removeOldImages(previewImage)}else{this.showImage(this.currentImageElement,qualityIndex,thumbNum,thumbUrl,false);this.currentImageElement.dataset.index=thumbNum;this.removeOldImages(this.currentImageElement)}}showImage(previewImage,qualityIndex,thumbNum,thumbFilename,newImage=true){this.player.debug.log(`Showing thumb: ${thumbFilename}. num: ${thumbNum}. qual: ${qualityIndex}. newimg: ${newImage}`);this.setImageSizeAndOffset(previewImage,thumbNum);if(newImage){this.currentImageContainer.appendChild(previewImage);this.currentImageElement=previewImage;if(!this.loadedImages.includes(thumbFilename)){this.loadedImages.push(thumbFilename)}}}removeOldImages(currentImage){Array.from(this.currentImageContainer.children).forEach(image=>{if(image.tagName.toLowerCase()!=="img"){return}const removeDelay=500;if(image.dataset.index!==currentImage.dataset.index&&!image.dataset.deleting){image.dataset.deleting=true;const{currentImageContainer}=this;setTimeout(()=>{currentImageContainer.removeChild(image);this.player.debug.log(`Removing thumb: ${image.dataset.filename}`)},removeDelay)}})}get currentImageContainer(){if(this.mouseDown){return this.elements.scrubbing.container}return this.elements.thumb.imageContainer}get thumbAspectRatio(){return this.config.width/this.config.height}get thumbContainerHeight(){if(this.mouseDown){return Math.floor(this.player.media.clientWidth/this.thumbAspectRatio)}return Math.floor(this.player.media.clientWidth/this.thumbAspectRatio/4)}get currentImageElement(){if(this.mouseDown){return this.currentScrubbingImageElement}return this.currentThumbnailImageElement}set currentImageElement(element){if(this.mouseDown){this.currentScrubbingImageElement=element}else{this.currentThumbnailImageElement=element}}toggleThumbContainer(toggle=false,clearShowing=false){const className=this.player.config.classNames.previewThumbnails.thumbContainerShown;this.elements.thumb.container.classList.toggle(className,toggle);if(!toggle&&clearShowing){this.showingThumb=null;this.showingThumbFilename=null}}toggleScrubbingContainer(toggle=false){const className=this.player.config.classNames.previewThumbnails.scrubbingContainerShown;this.elements.scrubbing.container.classList.toggle(className,toggle);if(!toggle){this.showingThumb=null;this.showingThumbFilename=null}}determineContainerAutoSizing(){if(this.elements.thumb.imageContainer.clientHeight>20){this.sizeSpecifiedInCSS=true}}setThumbContainerSizeAndPos(){if(!this.sizeSpecifiedInCSS){const thumbWidth=Math.floor(this.thumbContainerHeight*this.thumbAspectRatio);this.elements.thumb.imageContainer.style.height=`${this.thumbContainerHeight}px`;this.elements.thumb.imageContainer.style.width=`${thumbWidth}px`}this.setThumbContainerPos()}setThumbContainerPos(){const seekbarRect=this.player.elements.progress.getBoundingClientRect();const plyrRect=this.player.elements.container.getBoundingClientRect();const{container}=this.elements.thumb;const minVal=plyrRect.left-seekbarRect.left+10;const maxVal=plyrRect.right-seekbarRect.left-container.clientWidth-10;let previewPos=this.mousePosX-seekbarRect.left-container.clientWidth/2;if(previewPos<minVal){previewPos=minVal}if(previewPos>maxVal){previewPos=maxVal}container.style.left=`${previewPos}px`}setScrubbingContainerSize(){this.elements.scrubbing.container.style.width=`${this.player.media.clientWidth}px`;this.elements.scrubbing.container.style.height=`${this.player.media.clientWidth/this.thumbAspectRatio}px`}setImageSizeAndOffset(previewImage,frame){let config=this.config;let indexInPage=frame+1-config.col*config.row*(Math.ceil((frame+1)/(config.col*config.row))-1);let tnaiRowIndex=Math.ceil(indexInPage/config.row)-1;let tnaiColIndex=indexInPage-tnaiRowIndex*config.row-1;const multiplier=this.thumbContainerHeight/config.height;previewImage.style.height=`${Math.floor(previewImage.naturalHeight*multiplier)}px`;previewImage.style.width=`${Math.floor(previewImage.naturalWidth*multiplier)}px`;previewImage.style.left=`-${tnaiColIndex*config.width*multiplier}px`;previewImage.style.top=`-${tnaiRowIndex*config.height*multiplier}px`}}document.addEventListener("ready",event=>{const curPlayer=event.detail.plyr;curPlayer.thumbnails=new Thumbnails(curPlayer)})})(document);